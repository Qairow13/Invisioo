import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const { message } = await req.json();
    const apiKey = process.env.GEMINI_API_KEY;

    if (!apiKey) {
      console.error("‚ùå GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env.local");
      return NextResponse.json(
        { error: "–ù–µ—Ç API –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ" },
        { status: 500 }
      );
    }

    const userText = (message ?? "").toString().slice(0, 2000);

    // üëá –ó–∞–¥–∞—ë–º —Ä–æ–ª—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–∑–∞—Ç–æ—á–µ–Ω –ø–æ–¥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –≤–∞–∫–∞–Ω—Å–∏–∏)
    const prompt = `
–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç INVISIOO. 
–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ, –ø–æ –¥–µ–ª—É –∏ –ø—Ä–æ—Å—Ç—ã–º —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–º —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
- –ø–æ–º–æ–≥–∞—Ç—å –ª—é–¥—è–º —Å –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å—é —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç (–ø–∞–Ω–¥—É—Å—ã, –ª–∏—Ñ—Ç—ã, —Ç–∞–∫—Ç–∏–ª—å–Ω—ã–µ –¥–æ—Ä–æ–∂–∫–∏, —Ç—É–∞–ª–µ—Ç—ã –∏ —Ç.–¥.),
- –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∏–¥—ã —Ä–∞–±–æ—Ç—ã/–≤–∞–∫–∞–Ω—Å–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–∫–æ–ª—è—Å–æ—á–Ω–∏–∫, —Å–ª–∞–±–æ–≤–∏–¥—è—â–∏–π, –î–¶–ü –∏ —Ç.–ø.),
- –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π, –∞ –æ–ø–∏—Å—ã–≤–∞—Ç—å —Ç–∏–ø—ã —Ä–∞–±–æ—Ç: ¬´–æ–ø–µ—Ä–∞—Ç–æ—Ä –∫–æ–ª–ª-—Ü–µ–Ω—Ç—Ä–∞¬ª, ¬´–∞–Ω–∞–ª–∏—Ç–∏–∫¬ª, ¬´—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫¬ª, ¬´–∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä¬ª –∏ —Ç.–¥.
- –µ—Å–ª–∏ —Ç–µ–±—è —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç, –æ–±—ä—è—Å–Ω–∏ –≤ –æ–±—â–∏—Ö —á–µ—Ä—Ç–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–≤–∞–º –ø–æ–¥–æ–π–¥—ë—Ç –ø—É—Ç—å –±–µ–∑ –ª–µ—Å—Ç–Ω–∏—Ü, —Å –ª–∏—Ñ—Ç–æ–º¬ª), –Ω–æ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –∞–¥—Ä–µ—Å–∞, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –∑–Ω–∞–µ—à—å.

–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
${userText}
`;

    const res = await fetch(
      "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=" +
        apiKey,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            {
              role: "user",
              parts: [{ text: prompt }],
            },
          ],
        }),
      }
    );

    const data = await res.json();

    if (data.error) {
      console.error("‚ùå Gemini error:", data.error);
      return NextResponse.json(
        { error: "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini" },
        { status: 500 }
      );
    }

    const text =
      data?.candidates?.[0]?.content?.parts?.[0]?.text ??
      "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç üòî";

    return NextResponse.json({ reply: text });
  } catch (err) {
    console.error("‚ùå AI route crash:", err);
    return NextResponse.json(
      { error: "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" },
      { status: 500 }
    );
  }
}
