// app/api/chat/route.ts
import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const { messages } = body;

    if (!Array.isArray(messages)) {
      return NextResponse.json(
        { error: "messages must be an array" },
        { status: 400 }
      );
    }

    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      console.error("‚ùå –ù–µ—Ç OPENAI_API_KEY –≤ .env.local");
      return NextResponse.json(
        { error: "Server API key is not configured" },
        { status: 500 }
      );
    }

    const apiRes = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: `
–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–∞–π—Ç–∞ INVISIOO. –û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ–ª–µ–∑–Ω–æ.

–¢–í–û–Ø –§–£–ù–ö–¶–ò–Ø:
- –ø–æ–º–æ–≥–∞—Ç—å –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç, –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –º–∞—Ä—à—Ä—É—Ç–∞–º;
- –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏;
- –ø–æ–º–æ–≥–∞—Ç—å –≤ –≤—ã–±–æ—Ä–µ –º–µ—Å—Ç–∞ (–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞, –¢–†–¶, –±–∞–Ω–∫ –∏ —Ç.–ø.);
- –ø–æ–º–æ–≥–∞—Ç—å —Å —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Ä–≤–∏—Å–∞ INVISIOO: –Ω–∞–≤—ã–∫–∏, —Ä–µ–∑—é–º–µ, –≤—ã–±–æ—Ä –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:

1. –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–æ–≤–æ—Ä–∏ —Ñ—Ä–∞–∑ —Ç–∏–ø–∞:
   - "—è –Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å —Å –ø–æ–∏—Å–∫–æ–º –≤–∞–∫–∞–Ω—Å–∏–π"
   - "—É –º–µ–Ω—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
   - "—è –Ω–µ –º–æ–≥—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∞–π—Ç"
   –≠—Ç–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã.

2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ —Ä–∞–±–æ—Ç—É, –≤–∞–∫–∞–Ω—Å–∏–∏, –ø—Ä–æ—Ñ–µ—Å—Å–∏—é, —Ä–µ–∑—é–º–µ, –Ω–∞–≤—ã–∫–∏, –∑–∞—Ä–ø–ª–∞—Ç—É, —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:
   - –í–°–ï–ì–î–ê –≥–æ–≤–æ—Ä–∏, —á—Ç–æ –Ω–∞ —Å–∞–π—Ç–µ Invisioo –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª "–í–∞–∫–∞–Ω—Å–∏–∏".
   - –í–°–ï–ì–î–ê —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–π —Å—Å—ã–ª–∫—É: https://invisioo.kz/vacancies
   - –ù–ï —É–ø–æ–º–∏–Ω–∞–π –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ —Å–∞–π—Ç—ã (HeadHunter, LinkedIn, Jooble, Rabota –∏ —Ç.–ø.).
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–º–æ—â—å —Å –Ω–∞–≤—ã–∫–∞–º–∏ –∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ–∑—é–º–µ.
   - –û—Ç–≤–µ—á–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ.

   –ü—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è –æ—Ç–≤–µ—Ç–∞ (–∞–¥–∞–ø—Ç–∏—Ä—É–π –ø–æ–¥ –≤–æ–ø—Ä–æ—Å):
   "–ù–∞ —Å–∞–π—Ç–µ Invisioo –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª ¬´–í–∞–∫–∞–Ω—Å–∏–∏¬ª. –í–æ—Ç —Å—Å—ã–ª–∫–∞: https://invisioo.kz/vacancies
   –ú–æ–≥—É –ø–æ–º–æ—á—å –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å, –∫–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –∏ –∫–∞–∫ –ª—É—á—à–µ –æ—Ñ–æ—Ä–º–∏—Ç—å —Ä–µ–∑—é–º–µ –ø–æ–¥ —ç—Ç–∏ –≤–∞–∫–∞–Ω—Å–∏–∏."

3. –ù–∞ –≤–æ–ø—Ä–æ—Å "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å?":
   - —É–ø–æ–º–∏–Ω–∞–π –ø–æ–º–æ—â—å —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏;
   - –ø–æ–º–æ—â—å —Å –ø–æ–¥–±–æ—Ä–æ–º –º–µ—Å—Ç –ø–æ —Ç–∏–ø—É –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏;
   - –ø–æ–º–æ—â—å —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –∏ –Ω–∞–≤—ã–∫–æ–≤;
   - –ø–æ–º–æ—â—å —Å —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ–∑—é–º–µ;
   - —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ –≤–∞–∫–∞–Ω—Å–∏–∏ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–í–∞–∫–∞–Ω—Å–∏–∏" –Ω–∞ —Å–∞–π—Ç–µ Invisioo (https://invisioo.kz/vacancies).

4. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–º–ø–∞–Ω–∏—è—Ö.
   –ú–æ–∂–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–± –æ–±—â–∏—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö, –Ω–∞–≤—ã–∫–∞—Ö –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö.

5. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º –∏ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–º —è–∑—ã–∫–æ–º.
   –ö–æ—Ä–æ—Ç–∫–∏–µ, –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç–º–æ–¥–∑–∏, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ.

–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, —Ü–µ–ª—å –∫–æ—Ç–æ—Ä–æ–≥–æ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Ä–≤–∏—Å–∞ INVISIOO.
`,
          },
          ...messages,
        ],
        temperature: 0.4,
      }),
    });

    if (!apiRes.ok) {
      const errText = await apiRes.text();
      console.error("OpenAI API error:", errText);
      return NextResponse.json(
        { error: "Failed to call OpenAI" },
        { status: 500 }
      );
    }

    const data = await apiRes.json();

    const answer =
      data.choices?.[0]?.message?.content ??
      "–Ø –∑–∞—Ç—Ä—É–¥–Ω—è—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å üôè";

    return NextResponse.json({
      message: {
        role: "assistant",
        content: answer,
      },
    });
  } catch (e) {
    console.error("GPT route error:", e);
    return NextResponse.json(
      { error: "Internal error" },
      { status: 500 }
    );
  }
}
